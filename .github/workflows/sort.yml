name: Sort YAML

on:
  push:
    paths:
      - 'my-local-rules.yaml'
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sort-yaml:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install js-yaml

      - name: Sort payload alphabetically
        run: |
          node <<'EOF'
          const fs = require('fs');
          const yaml = require('js-yaml');

          const file = fs.readFileSync('my-local-rules.yaml', 'utf8');
          const data = yaml.load(file);

          if (Array.isArray(data.payload)) {
            data.payload = [...new Set(data.payload)]
              .sort((a, b) => a.localeCompare(b, 'ru', { sensitivity: 'base' }))
              .map(item => `'${item}'`); // оборачиваем в одинарные кавычки
          }

          fs.writeFileSync('my-local-rules.yaml', yaml.dump(data, { lineWidth: -1 }));
          EOF

      - name: Commit changes if any
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add my-local-rules.yaml
          git commit -m "Автосортировка payload по алфавиту с кавычками" || echo "No changes"
          git push
