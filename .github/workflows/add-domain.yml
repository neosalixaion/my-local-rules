name: Add domain from issue

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  update-rules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Extract and normalize domain
        id: parse
        run: |
          RAW_TITLE="${{ github.event.issue.title }}"
          DOMAIN=$(echo "$RAW_TITLE" | sed 's/Добавить: //' | sed 's/^www\.//' | tr -d '[:space:]')
          echo "DOMAIN=$DOMAIN" >> $GITHUB_ENV

      - name: Check if domain already exists
        id: check
        run: |
          if grep -q "+.$DOMAIN" my-local-rules.yaml; then
            echo "EXISTS=true" >> $GITHUB_ENV
          else
            echo "EXISTS=false" >> $GITHUB_ENV
          fi

      - name: Append domain if not exists
        if: env.EXISTS == 'false'
        run: |
          echo "  - +.$DOMAIN" >> my-local-rules.yaml

      - name: Commit and push changes
        if: env.EXISTS == 'false'
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git add my-local-rules.yaml
          git commit -m "Добавлен домен $DOMAIN из issue"
          git push

      - name: Close issue
        run: |
          curl -s -X PATCH \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }} \
            -d '{"state":"closed"}'
